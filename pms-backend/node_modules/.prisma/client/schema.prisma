datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================= Enums ============================= */

enum PreferredLanguage {
  en
  hi
  bn
  ta
  te
  mr
  pa
  or
  gu
  kn
  ml

  @@map("PreferredLanguage")
}

enum OperatingZone {
  NCR
  North
  South
  East
  West
  Central

  @@map("OperatingZone")
}

enum UserStatus {
  Active
  Inactive

  @@map("UserStatus")
}

enum CompanyStatus {
  Active
  Inactive

  @@map("CompanyStatus")
}

enum UserRole {
  Admin
  Client
  IH_PMT     @map("IH-PMT")
  Contractor
  Consultant
  PMC
  Supplier

  @@map("UserRole")
}

enum CompanyRole {
  IH_PMT     @map("IH-PMT")
  Contractor
  Consultant
  PMC
  Supplier

  @@map("CompanyRole")
}

enum StateType {
  State
  UT

  @@map("StateType")
}

enum ProjectStatus {
  Draft
  Active
  OnHold
  Completed
  Archived

  @@map("project_status")
}

enum ProjectStage {
  Planning
  Design
  Procurement
  Execution
  Handover
  Closed

  @@map("project_stage")
}

enum ProjectType {
  Residential
  Commercial
  Industrial
  Institutional
  MixedUse
  Infrastructure
  Other

  @@map("project_type")
}

enum StructureType {
  LowRise
  HighRise
  Villa
  RowHouse
  InteriorFitout
  ShellCore
  Other

  @@map("structure_type")
}

enum ConstructionType {
  New
  Renovation
  Retrofit
  Repair
  Fitout
  Other

  @@map("construction_type")
}

enum ContractType {
  LumpSum
  ItemRate
  Turnkey
  EPC
  PMC
  LabourOnly
  Other

  @@map("contract_type")
}

enum ProjectHealth {
  Green
  Amber
  Red
  Unknown

  @@map("project_health")
}

enum CurrencyCode {
  INR
  USD
  EUR
  GBP
  AED
  SAR
  SGD
  AUD
  Other

  @@map("currency_code")
}

enum AreaUnit {
  SQFT
  SQM
  SQYD
  Acre
  Hectare

  @@map("area_unit")
}

// Scope of a role (for multi-role users) */
enum RoleScope {
  Global
  Company
  Project

  @@map("RoleScope")
}

// ============================ Models ============================ */

model State {
  stateId   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code      String    @unique
  name      String    @unique
  type      StateType
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @db.Timestamptz(6)

  districts District[]
  users     User[]
  companies Company[]
  projects  Project[]

  @@map("State")
}

model District {
  districtId String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String
  stateId    String   @db.Uuid
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @db.Timestamptz(6)

  state State @relation(fields: [stateId], references: [stateId], onUpdate: Cascade, onDelete: Cascade)

  users     User[]
  companies Company[]
  projects  Project[]

  @@unique([stateId, name])
  @@map("District")
}

model User {
  userId            String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code              String?            @unique
  firstName         String
  middleName        String?
  lastName          String?
  countryCode       String
  phone             String
  email             String?            @unique
  preferredLanguage PreferredLanguage?
  profilePhoto      String?
  stateId           String?            @db.Uuid
  districtId        String?            @db.Uuid
  cityTown          String?
  pin               String?
  operatingZone     OperatingZone?
  address           String?
  isClient          Boolean?           @default(false)
  isServiceProvider Boolean?           @default(false)
  userStatus        UserStatus         @default(Active)
  passwordHash      String?
  isSuperAdmin      Boolean?           @default(false)
  createdAt         DateTime           @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime           @updatedAt @db.Timestamptz(6)

  // Optional legacy "primary role"
  userRole UserRole?

  state    State?    @relation(fields: [stateId], references: [stateId], onUpdate: Cascade, onDelete: SetNull)
  district District? @relation(fields: [districtId], references: [districtId], onUpdate: Cascade, onDelete: SetNull)

  // 1:M shortcuts
  projectsAsClient           Project[] @relation("ProjectClientUser")
  companiesAsServiceProvider Company[] @relation("CompanyServiceProviderUser")

  // Explicit M:N junctions
  userProjects  UserProject[]
  userCompanies UserCompany[]

  // Multi-role memberships
  userRoleMemberships UserRoleMembership[]

  @@unique([countryCode, phone], map: "User_cc_phone_unique")
  @@map("User")
}

model Company {
  companyId      String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String
  status         CompanyStatus @default(Active)
  website        String?
  companyRole    CompanyRole?
  gstin          String?       @unique
  pan            String?       @unique
  cin            String?       @unique
  primaryContact String?
  contactMobile  String?
  contactEmail   String?
  stateId        String?       @db.Uuid
  districtId     String?       @db.Uuid
  address        String?
  pin            String?
  notes          String?
  userId         String?       @db.Uuid

  // NEW
  companyCode String? @unique

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  state           State?    @relation(fields: [stateId], references: [stateId], onUpdate: Cascade, onDelete: SetNull)
  district        District? @relation(fields: [districtId], references: [districtId], onUpdate: Cascade, onDelete: SetNull)
  serviceProvider User?     @relation("CompanyServiceProviderUser", fields: [userId], references: [userId], onUpdate: Cascade, onDelete: Cascade)

  projects            Project[]            @relation("ProjectClientCompany")
  userCompanies       UserCompany[]
  userRoleMemberships UserRoleMembership[]

  @@map("Company")
}

model Project {
  projectId             String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title                 String
  code                  String?           @unique
  status                ProjectStatus     @default(Draft)
  stage                 ProjectStage?
  projectType           ProjectType?
  structureType         StructureType?
  constructionType      ConstructionType?
  contractType          ContractType?
  health                ProjectHealth     @default(Unknown)
  clientUserId          String?           @db.Uuid
  clientCompanyId       String?           @db.Uuid
  address               String?
  cityTown              String?
  stateId               String?           @db.Uuid
  districtId            String?           @db.Uuid
  pin                   String?
  latitude              Decimal?          @db.Decimal(9, 6)
  longitude             Decimal?          @db.Decimal(9, 6)
  startDate             DateTime?
  plannedCompletionDate DateTime?
  currency              CurrencyCode?     @default(INR)
  contractValue         Decimal?          @db.Decimal(18, 2)
  areaUnit              AreaUnit?
  plotArea              Decimal?          @db.Decimal(14, 2)
  builtUpArea           Decimal?          @db.Decimal(14, 2)
  floors                Int?
  description           String?
  createdAt             DateTime          @default(now()) @db.Timestamptz(6)
  updatedAt             DateTime          @updatedAt @db.Timestamptz(6)

  clientUser    User?     @relation("ProjectClientUser", fields: [clientUserId], references: [userId], onDelete: SetNull)
  clientCompany Company?  @relation("ProjectClientCompany", fields: [clientCompanyId], references: [companyId], onDelete: SetNull)
  state         State?    @relation(fields: [stateId], references: [stateId], onUpdate: Cascade, onDelete: SetNull)
  district      District? @relation(fields: [districtId], references: [districtId], onUpdate: Cascade, onDelete: SetNull)

  projectTags               ProjectTag[]
  userProjects              UserProject[] // junction backref
  userRoleMemberships       UserRoleMembership[] // role memberships scoped to this project
  PermissionProjectOverride PermissionProjectOverride[]

  @@map("Project")
}

model RefProjectTag {
  tagCode String @id
  label   String

  tags ProjectTag[]

  @@map("ref_project_tag")
}

model ProjectTag {
  projectId String @db.Uuid
  tagCode   String

  project Project       @relation(fields: [projectId], references: [projectId], onDelete: Cascade)
  tag     RefProjectTag @relation(fields: [tagCode], references: [tagCode], onDelete: Restrict)

  @@id([projectId, tagCode])
  @@map("ProjectTag")
}

// ===================== Junction tables (explicit M:N) ===================== */

model UserProject {
  userId    String   @db.Uuid
  projectId String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  user    User    @relation(fields: [userId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
  project Project @relation(fields: [projectId], references: [projectId], onDelete: Cascade, onUpdate: Cascade)

  @@id([userId, projectId])
  @@index([userId])
  @@index([projectId])
  @@map("UserProject")
}

model UserCompany {
  userId    String   @db.Uuid
  companyId String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  user    User    @relation(fields: [userId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
  company Company @relation(fields: [companyId], references: [companyId], onDelete: Cascade, onUpdate: Cascade)

  @@id([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@map("UserCompany")
}

// ================== Multi-role membership (with validity window) ================== */

model UserRoleMembership {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @db.Uuid
  role      UserRole
  scopeType RoleScope
  companyId String?   @db.Uuid
  projectId String?   @db.Uuid
  isDefault Boolean   @default(false)

  validFrom DateTime? @db.Timestamptz(6) // <- nullable
  validTo   DateTime? @db.Timestamptz(6) // <- nullable

  createdBy String? @db.Uuid
  notes     String?

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6) // <-- NEW

  user    User     @relation(fields: [userId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
  company Company? @relation(fields: [companyId], references: [companyId], onDelete: Cascade, onUpdate: Cascade)
  project Project? @relation(fields: [projectId], references: [projectId], onDelete: Cascade, onUpdate: Cascade)

  @@unique([userId, projectId, role, validFrom, validTo], map: "urm_unique_user_project_role_window")
  @@index([userId, role])
  @@index([companyId])
  @@index([projectId])
  @@index([projectId, role, validFrom, validTo], map: "urm_project_role_window_idx")
  @@index([userId, role, validFrom, validTo], map: "urm_user_role_window_idx")
  @@map("UserRoleMembership")
}

// --- Stores entire permission matrix (by module→actions) as JSON ---
model PermissionTemplate {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  role      UserRole @unique
  matrix    Json // { [moduleCode: string]: { view, raise, review, approve, close } }
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@map("PermissionTemplate")
}

model PermissionProjectOverride {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String   @db.Uuid
  role      UserRole
  matrix    Json
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  project Project @relation(fields: [projectId], references: [projectId], onDelete: Cascade, onUpdate: Cascade)

  @@unique([projectId, role], map: "ppo_project_role_unique")
  @@map("PermissionProjectOverride")
}
